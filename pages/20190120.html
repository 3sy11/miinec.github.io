<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>米de世界</title>
		<meta name="description" content="">
		<meta name="author" content="Miinec">

		<link rel="stylesheet" href="/theme/css/foundation.css" />
		<link rel="stylesheet" href="/theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="/theme/css/custom.css" />


		<script src="/theme/js/modernizr.js"></script>

		<!-- Feeds -->


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			jax: ["input/TeX", "output/HTML-CSS"],
			tex2jax: {
				inlineMath: [ ['$', '$'] ],
				displayMath: [ ['$$', '$$']],
				processEscapes: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
			},
			messageStyle: "none",
			"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
		});
		</script>
		<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">米de世界</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
						<li><a href="">Home</a></li>
						<li><label>Categories</label></li>
							<li ><a href="/category/du-shu-bi-ji.html">读书笔记</a></li>
							<li class="active"><a href="/category/ji-zhu.html">技术</a></li>
							<li ><a href="/category/ji-zhu-wen-zhang.html">技术文章</a></li>
							<li ><a href="/category/jing-ji-he-jin-rong.html">经济和金融</a></li>
							<li ><a href="/category/kuang-jia-he-gong-ju.html">框架和工具</a></li>
							<li ><a href="/category/shang-ye.html">商业</a></li>
							<li ><a href="/category/she-hui-ke-xue.html">社会科学</a></li>

						<li><label>Links</label></li>



						<li><label>Social</label></li>
							<li><a href="http://github.com/miinec/">github</a></li>
					</ul>	
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="/">米de世界</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li ><a href="/category/du-shu-bi-ji.html">读书笔记</a></li>
								<li class="active"><a href="/category/ji-zhu.html">技术</a></li>
								<li ><a href="/category/ji-zhu-wen-zhang.html">技术文章</a></li>
								<li ><a href="/category/jing-ji-he-jin-rong.html">经济和金融</a></li>
								<li ><a href="/category/kuang-jia-he-gong-ju.html">框架和工具</a></li>
								<li ><a href="/category/shang-ye.html">商业</a></li>
								<li ><a href="/category/she-hui-ke-xue.html">社会科学</a></li>
						</ul>
                        <ul class="right">                                                                                                                                           
                                                                                                                                             
                        </ul>  
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>Python__slots__详解</h2>
	<h2>Slots的实现</h2>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Member</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># 定义描述器实现slots属性的查找</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">_slotvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_slotvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">Type</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="c1"># 使用元类实现slots</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span>  <span class="n">namespace</span><span class="p">):</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_slots_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slots</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slots</span><span class="p">):</span>
                <span class="n">namespace</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">Member</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">original_init</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__init__&#39;</span><span class="p">)</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1"># 创建_slotvalues列表和调用原来的__init__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_slotvalues</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">original_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="n">original_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;__init__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="fm">__init__</span>
        <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

<span class="c1"># Python2与Python3使用元类的区别</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">Object</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="vm">__metaclass__</span> <span class="o">=</span> <span class="n">Type</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">Object</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Type</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="n">_slots_</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>


<blockquote>
<p>python对象中有个存在__dict__来存放所有属性，__slots__的作用是取代__dict___的，实现一个描述器（设计模式），从而对对象属性进行管理。</p>
</blockquote>
<h2>更快的属性访问速度</h2>
<p>默认情况下，访问一个实例的属性是通过访问该实例的__dict__来实现的。如访问<code>a.x</code>就相当于访问<code>a.__dict__['x']</code>。为了便于理解，我粗略地将它拆分为四步：</p>
<ul>
<li>a.x</li>
<li>a.<strong>dict</strong></li>
<li>a.<strong>dict</strong>['x']</li>
<li>结果</li>
</ul>
<p>从__slots__的实现可以得知，定义了__slots__的类会为每个属性创建一个描述器。访问属性时就直接调用这个描述器。在这里我将它拆分为三步：</p>
<ul>
<li>b.x</li>
<li>member decriptor</li>
<li>结果</li>
</ul>
<p>上文提到，访问__dict__和描述器的速度是相近的，而通过__dict__访问属性多了<code>a.__dict__['x']</code>字典访值一步（一个哈希函数的消耗）。由此可以推断出，使用了__slots__的类的属性访问速度比没有使用的要快。</p>
<h2>减少内存消耗</h2>
<p>Python内置的字典本质是一个哈希表，它是一种用空间换时间的数据结构。为了解决冲突的问题，<strong>当字典使用量超过2/3时，Python会根据情况进行2-4倍的扩容</strong>。由此可预见，取消__dict__的使用可以大幅减少实例的空间消耗。</p>
<h2>使用笔记</h2>
<h3>只有非字符串的迭代器可以赋值给__slots__</h3>
<h3>关于slots的继承问题</h3>
<ul>
<li>父类有，子类没有：子类的实例还是会自动创建__dict__来存储属性，不过父类__slots__已有的属性不受影响。</li>
<li>父类没有，子类有：虽然子类取消了__dict__，但继承父类后它会继续生成。同上面一样，__slots__已有的属性不受影响。</li>
<li>父类有，子类有：只有子类的__slots__有效，访问父类有子类没有的属性依然会报错。</li>
<li>多个拥有非空slots的父类：由于__slots__的实现不是简单的列表或字典，多个父类的非空__slots__不能直接合并，所以使用时会报错（即使多个父类的非空__slots__是相同的）。</li>
<li>多个空slots的父类：这是关于slots使用多继承唯一办法。</li>
<li>某些父类有，某些父类没有：跟第一种情况类似。</li>
</ul>
<p>为了正确使用__slots__，最好直接继承object。如有需要用到其他父类，则父类和子类都要定义slots，还要记得子类的slots会覆盖父类的slots。除非所有父类的slots都为空，否则不要使用多继承。</p>
<h3>添加__dict__获取动态特性</h3>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span> <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span><span class="o">.</span><span class="vm">__dict__</span>
<span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</code></pre></div>


<h3>添加__weakref__获取弱引用功能</h3>
<p>__slots__的实现不仅取消了__dict__的生成，也取消了__weakref__的生成。同样的，在__slots__将其添加可以重新获取弱引用这一功能。</p>
<h3>不能通过类属性给实例设定默认值</h3>
<p>定义了__slots__后，这个类的类属性都变为了描述器。如果给类属性赋值，就会把描述器给覆盖了。</p>
<h3>namedtuple</h3>
<p>利用内置的namedtuple不可变的特性，结合slots，能创建出一个轻量不可变的实例。(约等于一个元组的大小)</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">MyNt</span><span class="p">(</span><span class="n">namedtupele</span><span class="p">(</span><span class="s1">&#39;MyNt&#39;</span><span class="p">,</span> <span class="s1">&#39;bar baz&#39;</span><span class="p">)):</span> <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">MyNt</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nt</span><span class="o">.</span><span class="n">bar</span>
<span class="s1">&#39;r&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nt</span><span class="o">.</span><span class="n">baz</span>
<span class="s1">&#39;z&#39;</span>
</code></pre></div>


<p>当一个类需要创建大量实例时，可以使用__slots__来减少内存消耗。如果对访问属性的速度有要求，也可以酌情使用。另外可以利用slots的特性来限制实例的属性。而用在普通类身上时，使用__slots__后会丧失动态添加属性和弱引用的功能，进而引起其他错误，所以在一般情况下不要使用它。</p>
	<hr/>
	<h6>Written by <a href="/author/mii.html">Mii</a> in <a href="/category/ji-zhu.html">技术</a> on 周日 20 一月 2019. Tags: <a href="/tag/python.html">Python</a>, </h6>
</article>

<hr/>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<div class="panel">
								<h5>Links</h5>
								<ul class="side-nav">
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
									<li><a href="/tag/微服务.html" class="tag-4">微服务</a></li>
									<li><a href="/tag/信息论.html" class="tag-4">信息论</a></li>
									<li><a href="/tag/框架.html" class="tag-4">框架</a></li>
									<li><a href="/tag/docker.html" class="tag-4">docker</a></li>
									<li><a href="/tag/架构.html" class="tag-2">架构</a></li>
									<li><a href="/tag/系统.html" class="tag-4">系统</a></li>
									<li><a href="/tag/社交.html" class="tag-4">社交</a></li>
									<li><a href="/tag/内容.html" class="tag-4">内容</a></li>
									<li><a href="/tag/货币.html" class="tag-4">货币</a></li>
									<li><a href="/tag/交易.html" class="tag-4">交易</a></li>
									<li><a href="/tag/复杂系统.html" class="tag-4">复杂系统</a></li>
									<li><a href="/tag/规范.html" class="tag-4">规范</a></li>
									<li><a href="/tag/资讯.html" class="tag-4">资讯</a></li>
									<li><a href="/tag/crm.html" class="tag-4">CRM</a></li>
									<li><a href="/tag/控制论.html" class="tag-4">控制论</a></li>
									<li><a href="/tag/生态.html" class="tag-4">生态</a></li>
									<li><a href="/tag/django.html" class="tag-4">django</a></li>
									<li><a href="/tag/产品.html" class="tag-1">产品</a></li>
									<li><a href="/tag/中间件.html" class="tag-4">中间件</a></li>
									<li><a href="/tag/营销.html" class="tag-2">营销</a></li>
									<li><a href="/tag/文化.html" class="tag-4">文化</a></li>
									<li><a href="/tag/redis.html" class="tag-4">redis</a></li>
									<li><a href="/tag/容器化.html" class="tag-4">容器化</a></li>
									<li><a href="/tag/宏观经济.html" class="tag-4">宏观经济</a></li>
									<li><a href="/tag/心理.html" class="tag-4">心理</a></li>
									<li><a href="/tag/工业互联网.html" class="tag-4">工业互联网</a></li>
									<li><a href="/tag/政治.html" class="tag-4">政治</a></li>
									<li><a href="/tag/python.html" class="tag-2">python</a></li>
									<li><a href="/tag/设计.html" class="tag-2">设计</a></li>
									<li><a href="/tag/金融.html" class="tag-4">金融</a></li>
									<li><a href="/tag/数据.html" class="tag-4">数据</a></li>
									<li><a href="/tag/期权定价.html" class="tag-4">期权定价</a></li>
									<li><a href="/tag/理论.html" class="tag-4">理论</a></li>
									<li><a href="/tag/方法论.html" class="tag-2">方法论</a></li>
									<li><a href="/tag/案例.html" class="tag-2">案例</a></li>
									<li><a href="/tag/系统论.html" class="tag-4">系统论</a></li>
									<li><a href="/tag/投资.html" class="tag-2">投资</a></li>
									<li><a href="/tag/政策.html" class="tag-4">政策</a></li>
									<li><a href="/tag/运维.html" class="tag-4">运维</a></li>
									<li><a href="/tag/项目管理.html" class="tag-4">项目管理</a></li>
								</ul>
							</div>


							<div class="panel">
								<h5>Social</h5>
								<ul class="side-nav">
									<li><a href="http://github.com/miinec/">github</a></li>
								</ul>
							</div>
						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="/theme/js/jquery.js"></script>
		<script src="/theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>
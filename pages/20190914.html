<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>米de世界</title>
		<meta name="description" content="">
		<meta name="author" content="Miinec">

		<link rel="stylesheet" href="/theme/css/foundation.css" />
		<link rel="stylesheet" href="/theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="/theme/css/custom.css" />


		<script src="/theme/js/modernizr.js"></script>

		<!-- Feeds -->


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			jax: ["input/TeX", "output/HTML-CSS"],
			tex2jax: {
				inlineMath: [ ['$', '$'] ],
				displayMath: [ ['$$', '$$']],
				processEscapes: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
			},
			messageStyle: "none",
			"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
		});
		</script>
		<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">米de世界</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
						<li><a href="">Home</a></li>
						<li><label>Categories</label></li>
							<li ><a href="/category/du-shu-bi-ji.html">读书笔记</a></li>
							<li class="active"><a href="/category/ji-zhu.html">技术</a></li>
							<li ><a href="/category/ji-zhu-wen-zhang.html">技术文章</a></li>
							<li ><a href="/category/jing-ji-he-jin-rong.html">经济和金融</a></li>
							<li ><a href="/category/kuang-jia-he-gong-ju.html">框架和工具</a></li>
							<li ><a href="/category/shang-ye.html">商业</a></li>
							<li ><a href="/category/she-hui-ke-xue.html">社会科学</a></li>

						<li><label>Links</label></li>



						<li><label>Social</label></li>
							<li><a href="http://github.com/miinec/">github</a></li>
					</ul>	
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="/">米de世界</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li ><a href="/category/du-shu-bi-ji.html">读书笔记</a></li>
								<li class="active"><a href="/category/ji-zhu.html">技术</a></li>
								<li ><a href="/category/ji-zhu-wen-zhang.html">技术文章</a></li>
								<li ><a href="/category/jing-ji-he-jin-rong.html">经济和金融</a></li>
								<li ><a href="/category/kuang-jia-he-gong-ju.html">框架和工具</a></li>
								<li ><a href="/category/shang-ye.html">商业</a></li>
								<li ><a href="/category/she-hui-ke-xue.html">社会科学</a></li>
						</ul>
                        <ul class="right">                                                                                                                                           
                                                                                                                                             
                        </ul>  
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>从技术演变的角度看互联网后台架构</h2>
	<p>2019-04-14 <a href="https://mp.weixin.qq.com/s/ybQd4zXyfQlUdbvbQl0h9A">原文</a></p>
<h2>后台架构的演化</h2>
<h3>首先是2008年以前，我把它称为网站时代</h3>
<p><img alt="2000~2008:网站时代" src="https://pic4.zhimg.com/80/v2-d8bbc2b35f5a810170ec482f8ce20857_1440w.jpg"></p>
<p>这种简单的<strong>两层结构</strong>并不能说就是落后。在现在各个企业、公司以及小团队的大量web应用包括移动App的后端服务中，采用这种架构的不在少数，尤其是很多公司、学校、企业的<strong>内部服务</strong>，用这种架构已经足够了。</p>
<p>同时在中国，那个时候却是网络游戏MMO的黄金年代，对<strong>单机单服高并发实时交互的需求</strong>，远远压过了对<strong>海量数据data mining的需要</strong>，在这个时间点，中美两边的互联网科技树发生了比较大的分叉。这倒是并没有优劣之说，只是业务场景的重要性导致了技能树的侧重。直到今天，单机(包括简单的多服务器方案)高并发、高QPS仍然也是国内业界所追求的目标，而在美国那边，这只是一个业务指标而已，更看重的是如何进行水平扩展(horizontal scaling)和分散压力。</p>
<h3>到了2010年前后</h3>
<p><img alt="2009~2013:中间件时代" src="https://pic3.zhimg.com/80/v2-e27797679646e518bc580a2d6dd08502_1440w.jpg"></p>
<p>facebook的崛起也带动了其他大量的社交网站开始出现，社交网站最大的特点就是频繁的<strong>用户搜索</strong>、<strong>推荐</strong>，当用户上亿的时候，这就是前面传统的两层架构无法处理的问题了。</p>
<h3>2013年之后就是大数据+云的时代了</h3>
<p><img alt="2013~2017:大数据时代" src="https://pic3.zhimg.com/80/v2-b72bb1ea0b9a2b4fbccfc5e7e494789e_1440w.jpg"></p>
<p>左上角大致上也写了这个时代互联网业界的主要技术热点，实际上这也就是现在的热点。无论国内国外，绝大部分公司还并没有离开云+大数据这个时代。无论是大数据的实时处理、数据挖掘、推荐系统、Docker化，包括A/B测试，这些都是很多企业还正在努力全面解决的问题。</p>
<h3>2018~</h3>
<p><img alt="2018~??:AI时代" src="https://pic1.zhimg.com/80/v2-9591a31a85583b36088c41bcd974c324_1440w.jpg"></p>
<p>上图是facebook和uber的机器学习平台使用情况，基本上已经全部进入业务核心。</p>
<h2>Web Framework</h2>
<p><img alt="两个问题" src="https://pic2.zhimg.com/80/v2-204b4be768437cbf13bc8b47cab3be75_1440w.jpg"></p>
<p>最为诟病的无非是性能，然而实际上对非实时应用，晚个半秒一秒不应该是大问题，要考虑的是水平扩展scalability，不是实时响应（因为前提就是非实时应用）；其次实在不行你还有websocket可以用。</p>
<p>重点是要注意到<strong>middleware这个说法在web framework和后端架构中的意义不同</strong>。在web framework中是指具体处理GET/POST这些请求之前的<strong>一个通用处理（往往是链式调用）</strong>，比如可以把鉴权、一些日志处理和请求记录放在这里。但在后端架构设计中的middleware则是<strong>指类似消息队列、缓存这些在最终数据库之前的中间服务组件</strong>。</p>
<p><em>这一点可以用django的中间件，和分发系统的使用redis作为中间件来区别。</em></p>
<p><img alt="框架的使用" src="https://pic3.zhimg.com/80/v2-df43d5baa5c5622f11818b1c0587960a_1440w.jpg"></p>
<p>作为开发者则更多需要考虑如何定义配置文件，一些敏感参数如token、密码怎么传进来，开发环境和生产环境的配置如何自动切换，单元测试怎么搞，代码目录怎么组织。</p>
<h2>Middleware</h2>
<p><img alt="中间件定义" src="https://pic3.zhimg.com/80/v2-1ea807b76a16822bd099685837c44e26_1440w.jpg"></p>
<p><img alt="中台与中间件区别" src="https://pic1.zhimg.com/80/v2-590b5a370040ce103147825b1dbc4b00_1440w.jpg"></p>
<p>中间件的演化，一推荐系统为例</p>
<p><img alt="早期" src="https://pic4.zhimg.com/80/v2-d5ee9670feeda1685664ca268939d7ab_1440w.jpg"></p>
<p>推荐系统，对数据少用户少的情况下，简单的mysql即可，比如早期论坛的什么top 10热门话题啊，最多回复的话题啊，都可以视为简单的推荐，数据量又不大的情况下，直接select就可以了。</p>
<p><img alt="优化，引入缓存" src="https://pic4.zhimg.com/80/v2-10cc0cc71cb0dd2ad74c5ed7a0284f53_1440w.jpg"></p>
<p>那么，如果用户量多了呢？每次都去搜数据库，同时在线用户又多，那对数据库的压力就巨大了。这时候就是引入缓存，memcached、redis就出现了。</p>
<p>简单的做法就是把搜索条件作为key，把结果作为value存入缓存。打个比方你可以把key存为 20:40:beijing:male (20到40岁之间北京的男性），然后把第一次搜索的结果全部打乱shuffle后，存前1000个，10分钟过期，再有人用类似条件搜索，就直接把缓存数据随机挑几个返回。放心，一般来说不会有人10分钟就把1000个用户的资料都看完了，中间偶有重复也没人在意（用世纪佳缘、百合网啥的时候看到过重复的吧）。</p>
<p>加缓存是为了解决访问速度，减轻数据库压力，但是并不提高推荐精准度。如果我们要提高推荐效果呢？</p>
<p><img alt="引入离线排序/搜索引擎" src="https://pic2.zhimg.com/80/v2-43103b4967ade36bc23a4c588aa93319_1440w.jpg"></p>
<p>提高推荐效果，在机器学习之前有两种做法：</p>
<ul>
<li>
<p>引入基于lucene的搜索引擎，在搜索的同时通过定制方案实现scoring，比如我可以利用lucene对用户的年龄、性别、地址等进行indexing，但是<strong>再返回结果时我再根据用户和查询者两人的具体信息进行关联，自定义返回的score（可以视为推荐相关系数）</strong></p>
</li>
<li>
<p>采用离线批处理。固然可以用hadoop，但是就太杀鸡用牛刀了。常见的是定时批处理任务，按某种规则划分用户群体，对每个群体再做全量计算后把推荐结果写入缓存。这种可以做很繁复准确的计算，虽然慢，但效果往往不错。这种做法也常用在手机游戏的PvP对战列表里面。</p>
</li>
</ul>
<p><img alt="大数据时代" src="https://pic2.zhimg.com/80/v2-2c8b89684633800b68fd49df95eb8491_1440w.jpg"></p>
<p>这种对数据进行实时（近实时）处理的需求也带动了后端体系的大发展，kafka/spark等等流处理大行其道。这时候的后端体系就渐渐引入了消息驱动的模式，所谓消息驱动，就是对新的生产数据会有多个消费者，有的是满足实时计算的需求（比如司机信息需要立刻能够被快速检索到，又不能每次都做全量indexing，就需要用到spark），有的只是为了数据分析，写入类似cassandra这些数据库里，还有的可能是为了生成定时报表，写入到mysql。</p>
<p><img alt="机器学习/AI时代" src="https://pic1.zhimg.com/80/v2-aa8a341961199f2f90a5ae0d59af5298_1440w.jpg"></p>
<p>到了2017之后，前面千奇百怪的后端体系基本上都趋同了。kafka的实时消息队列，spark的流处理（当然现在也可以换成flink，不过大部分应该还是spark），然后后端的存储，基于hive的数据分析查询，然后根据业务的模型训练平台。</p>
<p><img alt="现代后端数据处理DAG形态" src="https://pic1.zhimg.com/80/v2-2d917d19d2ac06c55fb6698118d4afbc_1440w.jpg"></p>
<p>现代的后端数据处理越来越偏向于DAG的形态，Spark不说了，DAG是最大特色；神经网络本身也可以看作是一个DAG（RNN其实也可以看作无数个单向DNN的组合）；tensorflow也是强调其Graph是DAG，另外编程模式上，<strong>Reactive编程</strong>也很受追捧。</p>
<p>其实<strong>DAG的形态重点强调</strong>的就是<strong>数据本身是immutable（不可修改）</strong>，只能<strong>transform后成为新的数据</strong>进入下一环。这个思维其实可以贯穿到现代后台系统设计的每个环节，比如trakcing、analytics、数据表设计、microservice等等。</p>
<p><em>参考yelp的数据管道的文章，早年的数据流控制已经达到了那个效果，只是不停的替换工具。</em></p>
<p>无论如何，数据，数据的跟踪tracking，数据的流向，是现代后台系统的核心问题，只有data flow和data pipeline清晰了，整个后台架构才会清楚。</p>
<h2>DB &amp; Storage</h2>
<p><img alt="Database 分类" src="https://pic1.zhimg.com/80/v2-68ebb74553bfe58b8e9d45a4cb50e0f0_1440w.jpg"></p>
<p>有趣的是曾经看到一篇文章是aws CTO谈的一些内容，其中印象深刻是：<strong>如果你的用户还不到100万，就别折腾了，无脑使用mysql吧</strong></p>
<p>在2015年之前的一个趋势是不少公司使用mysql作为数据存储，但是把indexing放在外部去做。这个思路最早似乎是friendster提出的，后来uber也模仿这种做法设计了自己的数据库schemaless。然而随着postgreSQL的普及(postgreSQL支持对json的索引)，这种做法是否还有意义就值得商榷了。</p>
<p>列存储的一个重要领域是时序数据库，物联网用得多。其特色是大量写入，只增不改（不修改数据），但是读的次数相对于很少</p>
<h2>From Monolithic to Microservice</h2>
<ul>
<li>服务发现</li>
<li>微服务的配置和部署</li>
</ul>
<p><img alt="Monolithic vs Microservice" src="https://pic2.zhimg.com/80/v2-f9669af0efd0a133fa58ce0a30813c01_1440w.jpg"></p>
<p>这里要说并不是微服务解决一切，热门的Python Django尽管有restful-framework，但是它实际上是一个典型的Monolithic体系。对很多核心业务，其实未必要拆开成微服务。</p>
<h2>Docker 入门</h2>
<p>以前的开发环境,VM之前</p>
<p><img alt="Before VM" src="https://pic4.zhimg.com/80/v2-e15175f3e3a611aa2314df864a915f43_1440w.jpg"></p>
<p>也有直接在远程服务器安装环境后，多人共同登录远端开发，各自使用一个端口避免冲突…. 实际上这种土法炼钢的形态，在2019年的今天仍然在国内非常普及。</p>
<p>以前的开发环境,Docker之前</p>
<p><img alt="Before Docker" src="https://pic3.zhimg.com/80/v2-958630279c89bde1977993b38bd5f33a_1440w.jpg"></p>
<p>对比</p>
<p><img alt="Server/VM/Dokcer" src="https://pic1.zhimg.com/80/v2-34300341c5a98dcf80a857f30e8d5e6c_1440w.jpg"></p>
<p>Kubernetes</p>
<p><img alt="Kubernetes Dokcer" src="https://pic3.zhimg.com/80/v2-03fbbb243474fa5bf70b75ab81c0d2ce_1440w.jpg"></p>
<p>最后Kubernetes这里大概说说host-pod-container的关系，一个host可以是物理机或者vm，pod不是一个docker，而是可以看作有一个ip的...（不知道怎么形容），总之一个pod可以包括多个container(docker)，pod之中的container可以共享该pod的资源（ip，storage等）。不过现实中似乎大多是一个pod对一个container。</p>
	<hr/>
	<h6>Written by <a href="/author/mii.html">Mii</a> in <a href="/category/ji-zhu.html">技术</a> on 周六 14 九月 2019. Tags: <a href="/tag/jia-gou.html">架构</a>, <a href="/tag/she-ji.html">设计</a>, <a href="/tag/fang-fa-lun.html">方法论</a>, </h6>
</article>

<hr/>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<div class="panel">
								<h5>Links</h5>
								<ul class="side-nav">
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
									<li><a href="/tag/微服务.html" class="tag-4">微服务</a></li>
									<li><a href="/tag/信息论.html" class="tag-4">信息论</a></li>
									<li><a href="/tag/框架.html" class="tag-4">框架</a></li>
									<li><a href="/tag/docker.html" class="tag-4">docker</a></li>
									<li><a href="/tag/架构.html" class="tag-2">架构</a></li>
									<li><a href="/tag/系统.html" class="tag-4">系统</a></li>
									<li><a href="/tag/社交.html" class="tag-4">社交</a></li>
									<li><a href="/tag/内容.html" class="tag-4">内容</a></li>
									<li><a href="/tag/货币.html" class="tag-4">货币</a></li>
									<li><a href="/tag/交易.html" class="tag-4">交易</a></li>
									<li><a href="/tag/复杂系统.html" class="tag-4">复杂系统</a></li>
									<li><a href="/tag/规范.html" class="tag-4">规范</a></li>
									<li><a href="/tag/资讯.html" class="tag-4">资讯</a></li>
									<li><a href="/tag/crm.html" class="tag-4">CRM</a></li>
									<li><a href="/tag/控制论.html" class="tag-4">控制论</a></li>
									<li><a href="/tag/生态.html" class="tag-4">生态</a></li>
									<li><a href="/tag/django.html" class="tag-4">django</a></li>
									<li><a href="/tag/产品.html" class="tag-1">产品</a></li>
									<li><a href="/tag/中间件.html" class="tag-4">中间件</a></li>
									<li><a href="/tag/营销.html" class="tag-2">营销</a></li>
									<li><a href="/tag/文化.html" class="tag-4">文化</a></li>
									<li><a href="/tag/redis.html" class="tag-4">redis</a></li>
									<li><a href="/tag/容器化.html" class="tag-4">容器化</a></li>
									<li><a href="/tag/宏观经济.html" class="tag-4">宏观经济</a></li>
									<li><a href="/tag/心理.html" class="tag-4">心理</a></li>
									<li><a href="/tag/工业互联网.html" class="tag-4">工业互联网</a></li>
									<li><a href="/tag/政治.html" class="tag-4">政治</a></li>
									<li><a href="/tag/python.html" class="tag-2">python</a></li>
									<li><a href="/tag/设计.html" class="tag-2">设计</a></li>
									<li><a href="/tag/金融.html" class="tag-4">金融</a></li>
									<li><a href="/tag/数据.html" class="tag-4">数据</a></li>
									<li><a href="/tag/期权定价.html" class="tag-4">期权定价</a></li>
									<li><a href="/tag/理论.html" class="tag-4">理论</a></li>
									<li><a href="/tag/方法论.html" class="tag-2">方法论</a></li>
									<li><a href="/tag/案例.html" class="tag-2">案例</a></li>
									<li><a href="/tag/系统论.html" class="tag-4">系统论</a></li>
									<li><a href="/tag/投资.html" class="tag-2">投资</a></li>
									<li><a href="/tag/政策.html" class="tag-4">政策</a></li>
									<li><a href="/tag/运维.html" class="tag-4">运维</a></li>
									<li><a href="/tag/项目管理.html" class="tag-4">项目管理</a></li>
								</ul>
							</div>


							<div class="panel">
								<h5>Social</h5>
								<ul class="side-nav">
									<li><a href="http://github.com/miinec/">github</a></li>
								</ul>
							</div>
						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="/theme/js/jquery.js"></script>
		<script src="/theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>
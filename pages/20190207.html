<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>米de世界</title>
		<meta name="description" content="">
		<meta name="author" content="Miinec">

		<link rel="stylesheet" href="/theme/css/foundation.css" />
		<link rel="stylesheet" href="/theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="/theme/css/custom.css" />


		<script src="/theme/js/modernizr.js"></script>

		<!-- Feeds -->


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			jax: ["input/TeX", "output/HTML-CSS"],
			tex2jax: {
				inlineMath: [ ['$', '$'] ],
				displayMath: [ ['$$', '$$']],
				processEscapes: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
			},
			messageStyle: "none",
			"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
		});
		</script>
		<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">米de世界</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
						<li><a href="">Home</a></li>
						<li><label>Categories</label></li>
							<li ><a href="/category/du-shu-bi-ji.html">读书笔记</a></li>
							<li ><a href="/category/ji-zhu.html">技术</a></li>
							<li ><a href="/category/ji-zhu-wen-zhang.html">技术文章</a></li>
							<li ><a href="/category/jing-ji-he-jin-rong.html">经济和金融</a></li>
							<li class="active"><a href="/category/kuang-jia-he-gong-ju.html">框架和工具</a></li>
							<li ><a href="/category/shang-ye.html">商业</a></li>
							<li ><a href="/category/she-hui-ke-xue.html">社会科学</a></li>

						<li><label>Links</label></li>



						<li><label>Social</label></li>
							<li><a href="http://github.com/miinec/">github</a></li>
					</ul>	
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="/">米de世界</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li ><a href="/category/du-shu-bi-ji.html">读书笔记</a></li>
								<li ><a href="/category/ji-zhu.html">技术</a></li>
								<li ><a href="/category/ji-zhu-wen-zhang.html">技术文章</a></li>
								<li ><a href="/category/jing-ji-he-jin-rong.html">经济和金融</a></li>
								<li class="active"><a href="/category/kuang-jia-he-gong-ju.html">框架和工具</a></li>
								<li ><a href="/category/shang-ye.html">商业</a></li>
								<li ><a href="/category/she-hui-ke-xue.html">社会科学</a></li>
						</ul>
                        <ul class="right">                                                                                                                                           
                                                                                                                                             
                        </ul>  
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>django rest framework</h2>
	<p><em>原OneNote中得djaongo框架归档，不再做整理。</em></p>
<p><a href="https://www.bilibili.com/video/av28871471/">视频</a><br>
<a href="https://www.cnblogs.com/wupeiqi/articles/7805382.html">文字</a></p>
<h2>django FBV,CBV</h2>
<p>class base view<br>
django.view.View类，url路由需要调用类方法as_vews()来完成映射。<br>
as_vews() 返回一个封装dispatch()类方法的闭包。dispatch用于在Views类中映射method方法，返回执行函数。重写dispatch可以实现自定义View.http_method_names中的方法，包括get,post,put,patch,delete,head,trace。</p>
<p>url &gt; view() &gt; dispatch()</p>
<p><img alt="1.png" src="https://github.com/Miinec/imghost/raw/master/%E6%A1%86%E6%9E%B6%E5%92%8C%E5%B7%A5%E5%85%B7/django%20rest%20framework/1.png"></p>
<h3>django 中间件</h3>
<ul>
<li>process_requests  首先，先执行所有的中间件的此方法，完成路由匹配动作</li>
<li>process_view  接着所有的此方法，全部完成后执行视图函数。也可以用于检查视图是否被装饰，例如csrf_exempt,scrf_protect</li>
<li>process_respones  最后执行</li>
<li>process_excption  报错会执行</li>
<li>prcess_render_template  如果前三部，返回有render()方法才执行</li>
</ul>
<p><img alt="2.png" src="https://github.com/Miinec/imghost/raw/master/%E6%A1%86%E6%9E%B6%E5%92%8C%E5%B7%A5%E5%85%B7/django%20rest%20framework/2.png"></p>
<p>csrf token其实在1，2步都可以，但是存在需要跳过csrf的情况，而匹配到路由需要在第一步完成，所以是在第二部完成的。  </p>
<p>对于CBV，需要使用.utils.decorators.method_decorator(csrf_exempt,name='dispatch')来装饰类。方法一，对这个dispatch方法上装饰csrf_exepmt方法。方法二，直接.utils.decorators.method_decorator(csrf_exempt)装饰方法上</p>
<h3>面向对象</h3>
<p>封装，第一，相同的一大多方法和属性封装到类中，第二，通过构造方法把数据封装到每个对象中去。打包使用
继承，在父类实现相同的属性和方法，就可以提取基类。多继承，广度优先和深度优先。
多态，继承后重写方法，设计模式相关的可劲撤</p>
<h2>restful 规范</h2>
<h3>对于相同数据，根据method不同来进行增删改查</h3>
<p>post,delete,update,get等，基于CBV实现<br>
例如，www.example.com/api/v1/名词，名词可以是模型层的名称</p>
<h3>https</h3>
<h3>域名</h3>
<ul>
<li>子域名方式api.example.com</li>
<li>url方式www.example.com/api/</li>
</ul>
<h3>版本</h3>
<ul>
<li>url，www.example.com/api/v1/</li>
<li>请求头中加入</li>
</ul>
<h3>method</h3>
<ul>
<li>get</li>
<li>post</li>
<li>put 所有资源更新</li>
<li>patch 局部更新</li>
<li>delete</li>
</ul>
<h3>过滤</h3>
<p>url参数，对现有资源再做筛选，limit,offset,page,per_page,sortby,order,id</p>
<h3>状态码</h3>
<p>状态码和code结合使用，状态码用于游览器的，code用于自定义的</p>
<h3>错误处理</h3>
<p>error（msg）当key，错误信息是value。</p>
<h3>返回结果</h3>
<ul>
<li>GET /collection：返回资源对象的列表（数组）</li>
<li>GET /collection/1：返回单个资源对象</li>
<li>POST /collection：返回新生成的资源对象</li>
<li>PUT /collection/1：返回完整的资源对象</li>
<li>PATCH /collection/1：返回完整的资源对象</li>
<li>DELETE /collection/1：返回一个空文档</li>
</ul>
<h3>Hypermedia</h3>
<p>RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。比如返回的是所有数据的列表，其中就可以包含指向一条数据详细内容的url，可以避免去拼接url。</p>
<div class="highlight"><pre><span></span><code><span class="p">[{</span><span class="nt">&quot;link&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&quot;rel&quot;</span><span class="p">:</span>   <span class="s2">&quot;collection https://www.example.com/zoos&quot;</span><span class="p">,</span>
  <span class="nt">&quot;href&quot;</span><span class="p">:</span>  <span class="s2">&quot;https://api.example.com/zoos&quot;</span><span class="p">,</span>
  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;List of zoos&quot;</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span>  <span class="s2">&quot;application/vnd.yourformat+json&quot;</span>
<span class="p">}}]</span>
</code></pre></div>


<h2>django rest framework 框架</h2>
<h3>rest_framework.views.APIView CBV方式</h3>
<p>继承了django的View的原有功能。<br>
实质是重写了dispatch方法，其中加工了request对象，</p>
<h4>self.initialize_request(request),其中包括了</h4>
<ul>
<li>parsers，获取所有的解析器对象。</li>
<li>authenticators，用于认证的对象列表，这个类列表默认写在配置文件中，也可以自己定义视图参数authentication_classes=[]</li>
<li>negoiator，</li>
<li>parser_context.</li>
</ul>
<p>完成以上动作，返回一个封装好的request对象</p>
<h4>self.initial(封装后的request)，其中执行方法</h4>
<p>1.self.determine_version(request) 返回 version,scheme</p>
<p>URL参数或者URL正则都可以，hostname基于子域名实现，namespacedjango内置的方式，不常用，acceptheader请求头方式。
读取version类，并执行versioning_class(),在rest_framework.versioning.BaseVersioning,中的determine_version方法实现。类属性versioning_class来管理，指定唯一一个类。<br>
内置QueryParameterVersioning，可以使用参数来实现。并且有个defalut_version，is_allow_version来控制默认版本和多版本。在配置文件中可配置。<br>
另外一个reverse反向生成URL，其中参数viewname就是路由中的name参数。</p>
<p>2.self.perform_authentication(封装后的request)</p>
<p>然后执行的request.user,其中就是遍历对象的authenticate方法，如果是自定义可以参照rest_framework.authentication.BaseAuthentication，并且所有类继承该类，其中两个方法一个用于认证的authenticate，另一个用于认证失败修改请求头的authenticate_header。<br>
内置四种认证，一种游览器内置弹窗的登录窗口，一种token，一种会话，一种请求头中包含数据。<br>
如果验证通过，request.user则存放一个用户信息的元组，request.auth放一个token元组<br>
匿名用户可以在配置文件中配置</p>
<p><img alt="3.png" src="https://github.com/Miinec/imghost/raw/master/%E6%A1%86%E6%9E%B6%E5%92%8C%E5%B7%A5%E5%85%B7/django%20rest%20framework/3.png"></p>
<p>3.self.check_permissions(request)</p>
<p>实例化所有权限类，然后遍历对象的has_permission方法。返回true，false<br>
如果一直是true则通过，如果没有通过，则执行permission_denied，报出异常，认证失败。每一个权限对象，有一个message的参数可以设置，用于失败获取。<br>
使用方法与认证类似继承base基类</p>
<p>4.self.check_throttles(request)</p>
<p>控制访问频率，逻辑和权限类似
allow_request 返回 true（继续访问）和false，不允许访问则调用throtted(wait())抛出异常，wait返回字符串。<br>
内置的，获取IP来访问控制，self.get_ident方法返回IP。SimpleRateThrottle,其中有个rate（scope，这个参数可以配置不同用户权限的访问频率）参数从配置文件中获取设置duration,AnonRateThrottle,</p>
<h3>解析器*</h3>
<p>request.POST和request.body的区别<br>
需要识别content_type</p>
<ul>
<li>mulitpart/form-data 上传文件</li>
<li>application/x-www-form-urlencoded  会在body中解析数据转化，对数据格式有要求，格式类似于name=a&amp;age=1，此时requests.POST才有值。</li>
</ul>
<p>页面使用form标签的时候就会使用application/x-www-form-urlencoded这个头，ajax提交虽然是字典提交，但是也会默认转化为这个头。如果ajax定制请求头headers:{'Content-Typt':'application/json'},此时只有request.body内有值，POST没有值。</p>
<p>在rest framework中的rest_framework.parsers.JSONparser，被定义在视图层中的parser_classes中，则允许用户发json数据格式，会自动解析成字典，而不用jsonloads出来，解析好的后会放进request.data。只支持application/json头。</p>
<p>在rest framework中的rest_framework.parsers.FormParser,可以处理application/x-www-form-urlencoded头。 同时配置的时候就可以解析多种头了。</p>
<p><strong>如果请求了request.data才会去解析数据（耗时）</strong>,这个request是被框架重新封装过的request,调用_load_data_and_files方法，根据content_type来填充数据。request._parse方法，会根据配置的parser_clesses来获取解析器，执行解析器的parse方法</p>
<p>内置的包括，Base,Json,Form,MultiPart（上传文件）,FileUpload（上传）。<br>
dispatch先封装解析器，然后request.data请求是调用</p>
<h3>版本*</h3>
<p>见上面</p>
<h3>序列化***</h3>
<p>用于数据校验和queryset序列化<br>
rest_framework.serializers.Serializer，可以实现对模型层数据，序列化成json的操作。其中会定义类似模型层的各个字段，字段最好一一对应，指定source可以使用不同子弹，完全类似。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="n">ut_title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;ut.title&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">pwd</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">error_messages</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="s1">&#39;密码不能为空&#39;</span><span class="p">},</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">PasswordValidator</span><span class="p">(</span><span class="s1">&#39;666&#39;</span><span class="p">)])</span>

<span class="k">class</span> <span class="nc">TestView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># 序列化，将数据库查询字段序列化为字典</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">data_list</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># 或</span>
        <span class="c1"># obj = models.UserInfo.objects.all().first()</span>
        <span class="c1"># ser = UserSerializer(instance=obj, many=False)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>


<p>连表操作，如果需要对返回数据中包含的映射表指向的字段，需要将source换成"get_字段_dispaly"这种魔法方法，django会自动去寻找对应内容。这些魔法方法就是的ORM的复杂操作，还能实现"module.field.field.all"这样的操作。<br>
其中还有一种field=serializers.SerializerMethodField()的特殊字段用于处理多对多关系，此时是需要定义get_field方法来返回值。<br>
<strong>注意meta中增加depth参数可以实现上面所有效果，非常方便，如下示例。</strong><br>
.serializers.ModleSerializer可以使用Meta信息，来实现模型层所有的字段，避免自定义每个字段的系列化过程。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ModelUserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;__all__&quot;</span>
        <span class="c1"># fields = [&#39;user&#39;, &#39;pwd&#39;, &#39;ut&#39;]</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 这个可以深度数据字段，可以直接拿到字段</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span> <span class="s1">&#39;pwd&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;validators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">PasswordValidator</span><span class="p">(</span><span class="mi">666</span><span class="p">),</span> <span class="p">]}}</span>
        <span class="c1"># read_only_fields = [&#39;user&#39;]</span>
</code></pre></div>


<p>Hypermedia 的实现, serializers.HyperlinkedIdentityField，注意需要在路由里面设定别名，在序列化增加context参数，HyperlinkedIdentityField增加参数lookup_field（指定成模型层对应的id，例如group_id，gourp模型的id字段）和lookup_url_kwarg（指定为路由中正则部分的变量名称）参数指定生成的id，才能反向生成，如示例。</p>
<div class="highlight"><pre><span></span><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;test/&#39;</span><span class="p">,</span> <span class="n">TestView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;detail/(?P&lt;pk&gt;\d+)/&#39;</span><span class="p">,</span> <span class="n">TestView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">ModelUserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedIdentityField</span><span class="p">(</span><span class="n">view_name</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span><span class="n">lookup_field</span><span class="p">,</span><span class="n">lookup_url_kwarg</span><span class="p">)</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;__all__&quot;</span>
        <span class="n">list_serializer_class</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ListSerializer</span>

        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span>
            <span class="s1">&#39;pwd&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;validators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">PasswordValidator</span><span class="p">(</span><span class="mi">666</span><span class="p">),</span> <span class="p">]},</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;view_name&#39;</span><span class="p">:</span> <span class="s1">&#39;xxxx&#39;</span><span class="p">},</span>
            <span class="s1">&#39;ut&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;view_name&#39;</span><span class="p">:</span> <span class="s1">&#39;xxxx&#39;</span><span class="p">},</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">TestView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="n">ModelUserSerializer</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">data_list</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>


<p>初始化serializers基类，区分many参数是否生成ListSerializer来处理，QuerySet会由此次处理，其他对象由Serializer处理。<br>
调用request.data,执行to_represation 生成有序字典并调用每个字段的序列化方法来填充数据。调用fields.get_attribute对source解析填充，如果魔法方法是类似group.id则获取属性，如果是get_fields_disply则返回一个闭包，并执行结果后填充。（这个闭包应该是django内置的）</p>
<p>请求数据校验功能与原生的校验类似，将serializers替换为原来的就是了。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PasswordValidator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;This field must be </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer_field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This hook is called by the serializer instance,</span>
<span class="sd">        prior to the validation call being made.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 执行验证之前调用,serializer_fields是当前字段对象</span>
        <span class="k">pass</span>
</code></pre></div>


<h3>分页**</h3>
<p>第几页，某个位置之后的几条，加密分页</p>
<p>实例化调用rest_framework.pagination.PageNumberPagination().pagination_queryset(queryset,request,self)返回一个queryset对象列表，需要配置PAGE_SIZE和PARAM，MAX_PAGE_SIZE等参数。然后序列化这个对象列表返回即可。<br>
整体流程就是，先获取数据，创建分页对象，获取分页，序列化分页对象。</p>
<p>pageination对象有个get_paginated_response(ser.data)方法，可以返回一个增加更多信息的xhr，包括下页，总条数等信息。</p>
<p>rest_framework.pagination.LimitOffsetPagination()，可以配置位置信息进行分页offset就是索引的位置。</p>
<p>rest_framework.pagination.CursorPagination(),配置cursor的游标位置，排序顺序等，由于没有分页数字就需要返回get_paginated_response对象，一次避免直接插最后的数据。</p>
<h3>路由**</h3>
<p>生成路由，支持URI，中的www.xx.com/v1/1.json这样的</p>
<p>用以下方式可以自动生成增删改查四种类型路由</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
<span class="kn">from</span> <span class="nn">web.views</span> <span class="kn">import</span> <span class="n">s10_generic</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">s10_generic</span><span class="o">.</span><span class="n">UserViewSet</span><span class="p">)</span>
<span class="c1"># 这个就是注册users前缀到这个视图</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;版本/^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">]</span>
<span class="c1"># 在内部生成url路由</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ModelViewSet</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;__all__&quot;</span>


<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</code></pre></div>


<h3>视图**</h3>
<p>rest_framework.generic.GenernicAPIView，获取对象，序列化，分页，过滤等功能都封装进去了。</p>
<p>rest_framework.viewset.GenernicViewSet，重写了原有的as_view()功能，将get,post等方法映射到对应的函数方法，比如{'get':'list'}参数传入，则表示，get请求，执行list方法<br>
rest_framework.mixins.ListModelMixin,CreateModelMixin,诸如此类，实现了很多CURD方法，可以通过这种映射方式直接使用，结合GenernicViewSet,只需要写配置就可以了。</p>
<p>rest_framework.viewset.ModelViewSet，就是上述的集成。需要写url配置中的url正则。</p>
<p>上面的所有类，上一个是下一个的基类。</p>
<h3>渲染器*</h3>
<p>一次性配置，这个就是框架的接口测试页面，返回数据也有渲染好的，方便查看<br>
在app中注册好框架，然后属兔返回rest_frameword.response.Response(serialiser.data)就可以了。</p>
<p>APIView有个renderer_classes配置,rest_framework.renderer.JSONRenderer,BrowsableAPIRenderer,AdminRenderer,HTMLFormRenderder，着一系列的渲染器。</p>
<h2>contenttype</h2>
<p>django内置的组件，用于连表操作。数据库范式相关支持。需要注册在APP<br>
将表名作为一个字段存在另一张表里，实现索引到某张表的某个字段</p>
<p>django.contrib.contenttype.models.ContentType。在模型层中foreigenkey中传入这个类，content_type=foreignkey(ContentType)，content_object=genericforeignkey('conente_type','object_id')这样使用</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PricePolicy</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="n">price</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">IntergerField</span><span class="p">()</span>
  <span class="n">content_type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ContentType</span><span class="p">,</span><span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;关联的表名称&#39;</span><span class="p">)</span>
  <span class="n">object_id</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">IntergerFiedl</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;关联的表中的数据行的ID&#39;</span><span class="p">)</span>
  <span class="n">content_object</span><span class="o">=</span><span class="n">GenericForeignKey</span><span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span><span class="s1">&#39;object_id&#39;</span><span class="p">)</span>

<span class="n">obj</span><span class="o">=</span><span class="n">DegreeCourse</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">PricePolicy</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="k">print</span><span class="o">=</span><span class="s1">&#39;9.9&#39;</span><span class="p">,</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;30&#39;</span><span class="p">,</span><span class="n">content_object</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
</code></pre></div>


<h2>wsgi</h2>
<p>wsgi是协议，<br>
wsgiref,werkzeug,是wsgi协议的一个模块，本质是一个socket服务端，后者是flask框架只是用,前者是Django。<br>
tornado自己实现了一套。<br>
uwsgi,djaong<br>
不同模块，协议规范的参数不同</p>
	<hr/>
	<h6>Written by <a href="/author/mii.html">Mii</a> in <a href="/category/kuang-jia-he-gong-ju.html">框架和工具</a> on 周四 07 二月 2019. Tags: <a href="/tag/django.html">django</a>, <a href="/tag/kuang-jia.html">框架</a>, </h6>
</article>

<hr/>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<div class="panel">
								<h5>Links</h5>
								<ul class="side-nav">
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
									<li><a href="/tag/微服务.html" class="tag-4">微服务</a></li>
									<li><a href="/tag/信息论.html" class="tag-4">信息论</a></li>
									<li><a href="/tag/框架.html" class="tag-4">框架</a></li>
									<li><a href="/tag/docker.html" class="tag-4">docker</a></li>
									<li><a href="/tag/架构.html" class="tag-2">架构</a></li>
									<li><a href="/tag/系统.html" class="tag-4">系统</a></li>
									<li><a href="/tag/社交.html" class="tag-4">社交</a></li>
									<li><a href="/tag/内容.html" class="tag-4">内容</a></li>
									<li><a href="/tag/货币.html" class="tag-4">货币</a></li>
									<li><a href="/tag/交易.html" class="tag-4">交易</a></li>
									<li><a href="/tag/复杂系统.html" class="tag-4">复杂系统</a></li>
									<li><a href="/tag/规范.html" class="tag-4">规范</a></li>
									<li><a href="/tag/资讯.html" class="tag-4">资讯</a></li>
									<li><a href="/tag/crm.html" class="tag-4">CRM</a></li>
									<li><a href="/tag/控制论.html" class="tag-4">控制论</a></li>
									<li><a href="/tag/生态.html" class="tag-4">生态</a></li>
									<li><a href="/tag/django.html" class="tag-4">django</a></li>
									<li><a href="/tag/产品.html" class="tag-1">产品</a></li>
									<li><a href="/tag/中间件.html" class="tag-4">中间件</a></li>
									<li><a href="/tag/营销.html" class="tag-2">营销</a></li>
									<li><a href="/tag/文化.html" class="tag-4">文化</a></li>
									<li><a href="/tag/redis.html" class="tag-4">redis</a></li>
									<li><a href="/tag/容器化.html" class="tag-4">容器化</a></li>
									<li><a href="/tag/宏观经济.html" class="tag-4">宏观经济</a></li>
									<li><a href="/tag/心理.html" class="tag-4">心理</a></li>
									<li><a href="/tag/工业互联网.html" class="tag-4">工业互联网</a></li>
									<li><a href="/tag/政治.html" class="tag-4">政治</a></li>
									<li><a href="/tag/python.html" class="tag-2">python</a></li>
									<li><a href="/tag/设计.html" class="tag-2">设计</a></li>
									<li><a href="/tag/金融.html" class="tag-4">金融</a></li>
									<li><a href="/tag/数据.html" class="tag-4">数据</a></li>
									<li><a href="/tag/期权定价.html" class="tag-4">期权定价</a></li>
									<li><a href="/tag/理论.html" class="tag-4">理论</a></li>
									<li><a href="/tag/方法论.html" class="tag-2">方法论</a></li>
									<li><a href="/tag/案例.html" class="tag-2">案例</a></li>
									<li><a href="/tag/系统论.html" class="tag-4">系统论</a></li>
									<li><a href="/tag/投资.html" class="tag-2">投资</a></li>
									<li><a href="/tag/政策.html" class="tag-4">政策</a></li>
									<li><a href="/tag/运维.html" class="tag-4">运维</a></li>
									<li><a href="/tag/项目管理.html" class="tag-4">项目管理</a></li>
								</ul>
							</div>


							<div class="panel">
								<h5>Social</h5>
								<ul class="side-nav">
									<li><a href="http://github.com/miinec/">github</a></li>
								</ul>
							</div>
						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="/theme/js/jquery.js"></script>
		<script src="/theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>